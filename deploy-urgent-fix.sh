#!/bin/bash

echo "ğŸš¨ DÃ‰PLOIEMENT URGENT - CORRECTION ERREUR LOGIN 500"
echo "================================================="

echo "ğŸ“ PROBLÃˆME Ã€ RÃ‰SOUDRE:"
echo "- Erreur 500 lors du login en production"
echo "- Erreur PostgreSQL 'column ug.id does not exist' corrigÃ©e dans le code"
echo "- RedÃ©ploiement nÃ©cessaire pour appliquer les corrections"
echo ""

echo "ğŸš€ COMMANDES DE DÃ‰PLOIEMENT:"
echo ""
echo "1. ArrÃªter l'application actuelle:"
echo "   docker-compose down"
echo ""
echo "2. Nettoyer et reconstruire l'image avec les corrections:"
echo "   docker-compose build --no-cache logiflow-app"
echo ""
echo "3. RedÃ©marrer l'application corrigÃ©e:"
echo "   docker-compose up -d"
echo ""
echo "4. VÃ©rifier le dÃ©ploiement:"
echo "   docker-compose logs -f logiflow-app | head -30"
echo ""

echo "ğŸ¯ QUE SURVEILLER DANS LES LOGS:"
echo "âœ… 'Production Environment Configuration'"
echo "âœ… 'ğŸ”§ Creating users table with name column'"
echo "âœ… 'âœ… CRITICAL: Name column confirmed present'"
echo "âœ… 'âœ… CRITICAL: Default admin user created: admin/admin'"
echo "âœ… '[express] serving on port'"
echo ""
echo "âŒ Ã‰viter ces erreurs:"
echo "âŒ 'column ug.id does not exist'"
echo "âŒ 'Cannot convert undefined or null to object'"
echo "âŒ 'ERROR Response: 500'"
echo ""

echo "ğŸ”‘ TEST DE CONNEXION:"
echo "1. Aller sur: http://logiflow.ffnancy.fr:3000"
echo "2. Utiliser: admin / admin"
echo "3. Doit fonctionner sans erreur 500"
echo ""

echo "ğŸ’¡ SI Ã‡A NE FONCTIONNE TOUJOURS PAS:"
echo "1. VÃ©rifier les logs: docker-compose logs logiflow-app | tail -50"
echo "2. VÃ©rifier la base: docker-compose exec logiflow-postgres psql -U logiflow_admin -d logiflow_db -c '\\dt'"
echo "3. Tester l'API: curl http://logiflow.ffnancy.fr:3000/api/health"
echo ""

echo "ğŸ“Š CORRECTIONS APPLIQUÃ‰ES:"
echo "- RequÃªtes SQL user_groups sans rÃ©fÃ©rence Ã  ug.id"
echo "- ID composite user_id + group_id"
echo "- Table user_groups avec PRIMARY KEY(user_id, group_id)"
echo "- Build esbuild validÃ© : 285.8kb en 60ms"