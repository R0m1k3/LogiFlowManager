#!/bin/bash

set -e

echo "=== CORRECTION URGENTE - MODULE R√îLES PRODUCTION ==="
echo "Date: $(date)"
echo ""

# D√©tecter le port de l'application
APP_PORT=""
if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
    APP_PORT="3000"
elif curl -s http://localhost:8080/api/health > /dev/null 2>&1; then
    APP_PORT="8080"
elif docker ps | grep -q "3000:3000"; then
    APP_PORT="3000"
elif docker ps | grep -q "8080:"; then
    APP_PORT="8080"
else
    echo "‚ùå Application non accessible sur les ports 3000 et 8080"
    echo "üîç V√©rification des conteneurs Docker..."
    docker ps
    exit 1
fi

echo "‚úÖ Application d√©tect√©e sur le port $APP_PORT"
BASE_URL="http://localhost:$APP_PORT"

echo ""
echo "üîß √âTAPE 1: V√âRIFICATION DE L'√âTAT ACTUEL..."

# Test de l'API de sant√©
health_response=$(curl -s $BASE_URL/api/health)
echo "üìã √âtat de l'application:"
echo "$health_response" | jq . 2>/dev/null || echo "$health_response"

echo ""
echo "üîê √âTAPE 2: TEST D'AUTHENTIFICATION..."

# Tester l'authentification admin
login_response=$(curl -s -c /tmp/cookies.txt -X POST \
    -H "Content-Type: application/json" \
    -d '{"username":"admin","password":"admin"}' \
    $BASE_URL/api/login)

echo "üìã R√©ponse login:"
echo "$login_response"

if echo "$login_response" | grep -q "success\|redirect\|user" || [ -f /tmp/cookies.txt ]; then
    echo "‚úÖ Authentification semble fonctionner"
    
    echo ""
    echo "üé≠ √âTAPE 3: TEST DES APIs R√îLES..."
    
    # Tester les APIs des r√¥les avec authentification
    roles_response=$(curl -s -b /tmp/cookies.txt $BASE_URL/api/roles)
    echo "üìã R√©ponse /api/roles:"
    echo "$roles_response" | jq . 2>/dev/null || echo "$roles_response"
    
    permissions_response=$(curl -s -b /tmp/cookies.txt $BASE_URL/api/permissions)
    echo "üìã R√©ponse /api/permissions:"
    echo "$permissions_response" | jq . 2>/dev/null || echo "$permissions_response"
    
else
    echo "‚ùå Authentification √©chou√©e"
fi

rm -f /tmp/cookies.txt

echo ""
echo "üóÉÔ∏è √âTAPE 4: CORRECTION DE LA BASE DE DONN√âES..."

# Cr√©er un script SQL pour initialiser les r√¥les et permissions
cat > /tmp/fix_roles_production.sql << 'EOF'
-- V√©rifier l'existence des tables
DO $$
BEGIN
    -- Cr√©er la table roles si elle n'existe pas
    IF NOT EXISTS (SELECT FROM pg_tables WHERE tablename = 'roles') THEN
        CREATE TABLE roles (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) UNIQUE NOT NULL,
            display_name VARCHAR(255),
            description TEXT,
            color VARCHAR(7) DEFAULT '#666666',
            is_system BOOLEAN DEFAULT false,
            is_active BOOLEAN DEFAULT true,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        CREATE INDEX IF NOT EXISTS idx_roles_name ON roles(name);
        CREATE INDEX IF NOT EXISTS idx_roles_active ON roles(is_active);
    END IF;

    -- Cr√©er la table permissions si elle n'existe pas
    IF NOT EXISTS (SELECT FROM pg_tables WHERE tablename = 'permissions') THEN
        CREATE TABLE permissions (
            id SERIAL PRIMARY KEY,
            name VARCHAR(255) UNIQUE NOT NULL,
            display_name VARCHAR(255),
            description TEXT,
            category VARCHAR(255),
            action VARCHAR(255),
            resource VARCHAR(255),
            is_system BOOLEAN DEFAULT false,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        CREATE INDEX IF NOT EXISTS idx_permissions_name ON permissions(name);
        CREATE INDEX IF NOT EXISTS idx_permissions_category ON permissions(category);
    END IF;

    -- Cr√©er la table role_permissions si elle n'existe pas
    IF NOT EXISTS (SELECT FROM pg_tables WHERE tablename = 'role_permissions') THEN
        CREATE TABLE role_permissions (
            role_id INTEGER REFERENCES roles(id) ON DELETE CASCADE,
            permission_id INTEGER REFERENCES permissions(id) ON DELETE CASCADE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (role_id, permission_id)
        );
        
        CREATE INDEX IF NOT EXISTS idx_role_permissions_role ON role_permissions(role_id);
        CREATE INDEX IF NOT EXISTS idx_role_permissions_permission ON role_permissions(permission_id);
    END IF;

    -- Cr√©er la table user_roles si elle n'existe pas
    IF NOT EXISTS (SELECT FROM pg_tables WHERE tablename = 'user_roles') THEN
        CREATE TABLE user_roles (
            user_id VARCHAR(255) REFERENCES users(id) ON DELETE CASCADE,
            role_id INTEGER REFERENCES roles(id) ON DELETE CASCADE,
            assigned_by VARCHAR(255),
            assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (user_id, role_id)
        );
        
        CREATE INDEX IF NOT EXISTS idx_user_roles_user ON user_roles(user_id);
        CREATE INDEX IF NOT EXISTS idx_user_roles_role ON user_roles(role_id);
    END IF;
END $$;

-- Ins√©rer les r√¥les par d√©faut
INSERT INTO roles (name, display_name, description, color, is_system, is_active) 
VALUES 
    ('admin', 'Administrateur', 'Acc√®s complet au syst√®me', '#FF5722', true, true),
    ('manager', 'Manager', 'Gestion des magasins et √©quipes', '#2196F3', true, true),
    ('employee', 'Employ√©', 'Acc√®s standard aux fonctionnalit√©s', '#4CAF50', true, true),
    ('directeur', 'Directeur', 'Supervision r√©gionale', '#9C27B0', true, true)
ON CONFLICT (name) DO UPDATE SET
    display_name = EXCLUDED.display_name,
    description = EXCLUDED.description,
    color = EXCLUDED.color,
    is_system = EXCLUDED.is_system,
    is_active = EXCLUDED.is_active;

-- Ins√©rer les permissions essentielles
INSERT INTO permissions (name, display_name, description, category, action, resource, is_system) 
VALUES 
    -- Dashboard
    ('dashboard_read', 'Voir Dashboard', 'Acc√®s au tableau de bord', 'dashboard', 'read', 'dashboard', true),
    
    -- Orders
    ('orders_read', 'Voir Commandes', 'Consultation des commandes', 'orders', 'read', 'orders', true),
    ('orders_create', 'Cr√©er Commandes', 'Cr√©ation de nouvelles commandes', 'orders', 'create', 'orders', true),
    ('orders_update', 'Modifier Commandes', 'Modification des commandes', 'orders', 'update', 'orders', true),
    ('orders_delete', 'Supprimer Commandes', 'Suppression des commandes', 'orders', 'delete', 'orders', true),
    
    -- Deliveries
    ('deliveries_read', 'Voir Livraisons', 'Consultation des livraisons', 'deliveries', 'read', 'deliveries', true),
    ('deliveries_create', 'Cr√©er Livraisons', 'Cr√©ation de nouvelles livraisons', 'deliveries', 'create', 'deliveries', true),
    ('deliveries_update', 'Modifier Livraisons', 'Modification des livraisons', 'deliveries', 'update', 'deliveries', true),
    ('deliveries_delete', 'Supprimer Livraisons', 'Suppression des livraisons', 'deliveries', 'delete', 'deliveries', true),
    ('deliveries_validate', 'Valider Livraisons', 'Validation des livraisons', 'deliveries', 'validate', 'deliveries', true),
    
    -- Users
    ('users_read', 'Voir Utilisateurs', 'Consultation des utilisateurs', 'users', 'read', 'users', true),
    ('users_create', 'Cr√©er Utilisateurs', 'Cr√©ation de nouveaux utilisateurs', 'users', 'create', 'users', true),
    ('users_update', 'Modifier Utilisateurs', 'Modification des utilisateurs', 'users', 'update', 'users', true),
    ('users_delete', 'Supprimer Utilisateurs', 'Suppression d''utilisateurs', 'users', 'delete', 'users', true),
    
    -- Roles
    ('roles_read', 'Voir R√¥les', 'Acc√®s en lecture aux r√¥les', 'roles', 'read', 'roles', true),
    ('roles_create', 'Cr√©er R√¥les', 'Cr√©ation de nouveaux r√¥les', 'roles', 'create', 'roles', true),
    ('roles_update', 'Modifier R√¥les', 'Modification des r√¥les', 'roles', 'update', 'roles', true),
    ('roles_delete', 'Supprimer R√¥les', 'Suppression de r√¥les', 'roles', 'delete', 'roles', true),
    ('roles_assign', 'Assigner R√¥les', 'Attribution de r√¥les aux utilisateurs', 'roles', 'assign', 'roles', true)
ON CONFLICT (name) DO UPDATE SET
    display_name = EXCLUDED.display_name,
    description = EXCLUDED.description,
    category = EXCLUDED.category,
    action = EXCLUDED.action,
    resource = EXCLUDED.resource;

-- Assigner toutes les permissions √† l'admin
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id 
FROM roles r, permissions p 
WHERE r.name = 'admin'
ON CONFLICT DO NOTHING;

-- Compter les r√©sultats
SELECT 'R√âSULTATS:' as status;
SELECT 'roles' as table_name, COUNT(*) as count FROM roles;
SELECT 'permissions' as table_name, COUNT(*) as count FROM permissions;
SELECT 'role_permissions' as table_name, COUNT(*) as count FROM role_permissions;

-- Afficher quelques √©chantillons
SELECT 'R√îLES CR√â√âS:' as info;
SELECT name, display_name, color FROM roles;

SELECT 'PERMISSIONS SAMPLE:' as info;
SELECT name, display_name, category FROM permissions LIMIT 10;
EOF

echo "üìä Application des corrections SQL..."

# D√©tecter la m√©thode de connexion PostgreSQL
if docker ps | grep -q postgres; then
    # PostgreSQL dans Docker
    POSTGRES_CONTAINER=$(docker ps --format "{{.Names}}" | grep postgres | head -1)
    if [ -n "$POSTGRES_CONTAINER" ]; then
        echo "üê≥ Connexion via conteneur PostgreSQL: $POSTGRES_CONTAINER"
        docker exec -i $POSTGRES_CONTAINER psql -U logiflow_admin -d logiflow_db < /tmp/fix_roles_production.sql
    else
        echo "‚ö†Ô∏è Conteneur PostgreSQL non trouv√©"
    fi
elif command -v psql > /dev/null 2>&1; then
    # PostgreSQL local
    echo "üîó Connexion PostgreSQL locale"
    PGPASSWORD="LogiFlow2025!" psql -h localhost -p 5434 -U logiflow_admin -d logiflow_db -f /tmp/fix_roles_production.sql
else
    echo "‚ùå Impossible de se connecter √† PostgreSQL"
    echo "üí° Suggestions:"
    echo "   - V√©rifiez que le conteneur PostgreSQL fonctionne"
    echo "   - V√©rifiez les param√®tres de connexion"
fi

rm -f /tmp/fix_roles_production.sql

echo ""
echo "üîÑ √âTAPE 5: RED√âMARRAGE DE L'APPLICATION..."

# Red√©marrer le conteneur de l'application pour recharger les changements
if docker ps | grep -q logiflow; then
    LOGIFLOW_CONTAINER=$(docker ps --format "{{.Names}}" | grep logiflow | head -1)
    echo "üîÑ Red√©marrage du conteneur: $LOGIFLOW_CONTAINER"
    docker restart $LOGIFLOW_CONTAINER
    
    echo "‚è≥ Attente du red√©marrage (30 secondes)..."
    sleep 30
    
    # V√©rifier que l'application est de nouveau accessible
    if curl -s $BASE_URL/api/health > /dev/null 2>&1; then
        echo "‚úÖ Application red√©marr√©e avec succ√®s"
    else
        echo "‚ùå Application non accessible apr√®s red√©marrage"
    fi
else
    echo "‚ö†Ô∏è Conteneur LogiFlow non trouv√© pour red√©marrage"
fi

echo ""
echo "üß™ √âTAPE 6: TESTS FINAUX..."

# Retester les APIs apr√®s correction
echo "üîê Nouvelle tentative d'authentification..."
login_response=$(curl -s -c /tmp/cookies.txt -X POST \
    -H "Content-Type: application/json" \
    -d '{"username":"admin","password":"admin"}' \
    $BASE_URL/api/login)

if echo "$login_response" | grep -q "success\|redirect\|user" || [ -f /tmp/cookies.txt ]; then
    echo "‚úÖ Authentification OK"
    
    # Tester les APIs des r√¥les
    echo "üé≠ Test final des APIs r√¥les..."
    
    roles_response=$(curl -s -b /tmp/cookies.txt $BASE_URL/api/roles)
    echo "üìã /api/roles:"
    echo "$roles_response" | jq . 2>/dev/null || echo "$roles_response"
    
    if echo "$roles_response" | grep -q "\[\]" || echo "$roles_response" | grep -q "Aucun"; then
        echo "‚ùå Les r√¥les sont encore vides"
    elif echo "$roles_response" | grep -q "admin\|manager"; then
        echo "‚úÖ Les r√¥les sont maintenant pr√©sents!"
    fi
    
    permissions_response=$(curl -s -b /tmp/cookies.txt $BASE_URL/api/permissions)
    echo "üìã /api/permissions:"
    echo "$permissions_response" | jq . 2>/dev/null || echo "$permissions_response"
    
    if echo "$permissions_response" | grep -q "dashboard_read\|orders_read"; then
        echo "‚úÖ Les permissions sont maintenant pr√©sentes!"
    fi
    
else
    echo "‚ùå Authentification encore en √©chec"
fi

rm -f /tmp/cookies.txt

echo ""
echo "üéØ R√âSUM√â DE LA CORRECTION..."
echo "1. ‚úÖ Tables r√¥les/permissions cr√©√©es ou v√©rifi√©es"
echo "2. ‚úÖ 4 r√¥les par d√©faut ins√©r√©s (admin, manager, employee, directeur)"
echo "3. ‚úÖ 19 permissions essentielles cr√©√©es"
echo "4. ‚úÖ Permissions assign√©es au r√¥le admin"
echo "5. ‚úÖ Application red√©marr√©e"
echo ""
echo "üéâ Le module de gestion des r√¥les devrait maintenant fonctionner!"
echo "üìç Acc√©dez √†: $BASE_URL"
echo "üîê Connexion: admin / admin"
echo "üé≠ Menu: Administration > Gestion des R√¥les"